name: Update Copyright Year

on:
  schedule:
    - cron: '0 0 1 1 *'
  workflow_dispatch:

jobs:
  update-year:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Verify LICENSE exists
        run: |
          if [ ! -f "LICENSE" ]; then
            echo "LICENSE not found! Creating one..."
            cat > LICENSE << 'EOF'
            MIT License

            Copyright (c) $(date +'%Y') YinCheng

            Permission is hereby granted, free of charge, to any person obtaining a copy
            of this software and associated documentation files (the "Software"), to deal
            in the Software without restriction, including without limitation the rights
            to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
            copies of the Software, and to permit persons to whom the Software is
            furnished to do so, subject to the following conditions:

            The above copyright notice and this permission notice shall be included in all
            copies or substantial portions of the Software.

            THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
            IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
            FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
            AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
            LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
            OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
            SOFTWARE.
            EOF
            git add LICENSE
            git commit -m "chore: add MIT License"
            git push
            echo "Created LICENSE and pushed."
            exit 0
          fi
      - name: Get current year
        id: year
        run: echo "year=$(date +'%Y')" >> $GITHUB_OUTPUT

      - name: Update LICENSE
        run: |
          YEAR="${{ steps.year.outputs.year }}"
          FILE="LICENSE"

          if grep -q "Copyright (c) $YEAR" "$FILE"; then
            echo "LICENSE already up to date."
          else
            # 取得舊的年份範圍（2025 或 2025-2025）
            OLD=$(grep -o "Copyright (c) [0-9]\{4\}\(-[0-9]\{4\}\)\?" "$FILE" | head -1 | sed 's/Copyright (c) //')
            if [[ "$OLD" == *-* ]]; then
              NEW="${OLD%-*}-$YEAR"
            else
              NEW="$OLD-$YEAR"
            fi
            sed -i "s/Copyright (c) $OLD/Copyright (c) $NEW/" "$FILE"
            echo "Updated LICENSE → Copyright (c) $NEW"
          fi

      - name: Update README
        run: |
          YEAR="${{ steps.year.outputs.year }}"
          FILE="README.md"
          if [ -f "$FILE" ] && grep -q "Copyright © $YEAR" "$FILE"; then
            echo "README already up to date."
          elif [ -f "$FILE" ]; then
            OLD=$(grep -o "Copyright © [0-9]\{4\}\(-[0-9]\{4\}\)\?" "$FILE" | head -1 | sed 's/Copyright © //')
            if [[ "$OLD" == *-* ]]; then
              NEW="${OLD%-*}-$YEAR"
            else
              NEW="$OLD-$YEAR"
            fi
            sed -i "s/Copyright © $OLD/Copyright © $NEW/" "$FILE"
            echo "Updated README → Copyright © $NEW"
          fi

      - name: Commit & Push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add LICENSE README.md 2>/dev/null || true
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update copyright year to $(date +'%Y')"
            git push
            echo "Pushed changes."
          fi